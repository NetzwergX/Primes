version: v1.0
name: Build And Release
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
fail_fast:
  cancel:
    when: 'true'
auto_cancel:
  running:
    when: 'true'
blocks:
  - name: Build Aurelia SPA
    task:
      jobs:
        - name: npx eslint
          commands:
            - 'npx eslint ./src --ext .ts,.tsx --report-unused-disable-directives'
        - name: npm run build
          commands:
            - npm run build
            - artifact push workflow ./dist/ --destination aurelia-spa
      env_vars:
        - name: FOO_1
          value: BAR_1
      prologue:
        commands:
          - '# Get the latest version of our source code from GitHub:'
          - checkout
          - cd aurelia-spa/
          - '# Use the version of Node.js specified in .nvmrc.'
          - '# Semaphore provides nvm preinstalled.'
          - nvm use
          - node --version
          - npm --version
          - cache restore
          - npm install --quiet
          - cache store
    dependencies: []
  - name: Build DotNet API
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
        containers:
          - name: main
            image: 'mcr.microsoft.com/dotnet/core/sdk:latest'
      jobs:
        - name: dotnet publish
          commands:
            - dotnet restore --packages $NUGET_PACKAGES_DIRECTORY
            - dotnet publish --configuration Release --no-restore
            - artifact push workflow ./dotnet-web-api/Prime.WebApi/bin/Release/netcoreapp3.1/publish/ --destination api-dotnet/
      prologue:
        commands:
          - checkout
          - cd dotnet-web-api/
      env_vars:
        - name: NUGET_PACKAGES_DIRECTORY
          value: .nuget
  - name: 'Dockerize '
    dependencies:
      - Build Aurelia SPA
      - Build Quarkus API
      - DotNet Test
    task:
      jobs:
        - name: docker build primes/api-dotnet
          commands:
            - cd dotnet-web-api/Prime.WebApi/
            - 'docker build --pull -t "primes/api-dotnet:$SEMAPHORE_GIT_SHA"  .'
        - name: docker build primes/api-quarkus
          commands:
            - cd quarkus-api/
            - 'docker build -f ./src/main/docker/Dockerfile.jvm -t "primes/api-quarkus:$SEMAPHORE_GIT_SHA" .'
        - name: docker build primes/web-app
          commands:
            - artifact pull workflow aurelia-spa --destination lighttpd/htdocs
            - 'docker build -t "primes/web-app:$SEMAPHORE_GIT_SHA" lighttpd/'
      prologue:
        commands:
          - checkout
  - name: Generate Changelog
    dependencies: []
    task:
      jobs:
        - name: git-changelog
          commands:
            - echo "Fake Generate Changelog"
  - name: Generate Release
    dependencies:
      - 'Dockerize '
      - Generate Changelog
    task:
      jobs:
        - name: Do some release stuff...
          commands:
            - echo "Fake release"
  - name: Build Quarkus API
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
        containers:
          - name: main
            image: ' oracle/graalvm-ce:20.3.0-java11'
      jobs:
        - name: mvn package
          commands:
            - ./mvnw $MAVEN_CLI_OPTS clean package $MAVEN_OPTS
      env_vars:
        - name: MAVEN_CLI_OPTS
          value: '--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true'
        - name: MAVEN_OPTS
          value: '-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true'
      prologue:
        commands:
          - checkout
          - cd quarkus-api/
          - chmod +x ./mvnw
  - name: DotNet Benchmark
    dependencies:
      - Build DotNet API
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: dotnet benchmark
          commands:
            - checkout
            - cd dotnet-web-api/
            - 'artifact pull workflow api-dotnet/ --destination ./dotnet-web-api/Prime.WebApi/bin/Release/netcoreapp3.1/publish/ '
  - name: DotNet Test
    dependencies:
      - Build DotNet API
    task:
      prologue:
        commands:
          - checkout
          - cd dotnet-web-api/
          - 'artifact pull workflow api-dotnet/ --destination ./dotnet-web-api/Prime.WebApi/bin/Release/netcoreapp3.1/publish/ '
      jobs:
        - name: dotnet test
          commands:
            - 'dotnet test /p:CollectCoverage=true /p:CoverletOutput=''../artifacts/coverage.json'' --test-adapter-path:. --logger:"junit;LogFilePath=..\artifacts\{assembly}-test-result.xml;MethodFormat=Class;FailureBodyFormat=Verbose"'
