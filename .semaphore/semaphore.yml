version: v1.0
name: Build And Release
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
fail_fast:
  cancel:
    when: 'true'
auto_cancel:
  running:
    when: 'true'
blocks:
  - name: Build Aurelia SPA
    task:
      jobs:
        - name: npx eslint
          commands:
            - 'npx eslint ./src --ext .ts,.tsx --report-unused-disable-directives'
        - name: npm run build
          commands:
            - npm run build
            - artifact push workflow ./dist/ --destination aurelia-spa
      env_vars:
        - name: FOO_1
          value: BAR_1
      prologue:
        commands:
          - '# Get the latest version of our source code from GitHub:'
          - checkout
          - cd aurelia-spa/
          - '# Use the version of Node.js specified in .nvmrc.'
          - '# Semaphore provides nvm preinstalled.'
          - nvm use
          - node --version
          - npm --version
          - cache restore
          - npm install --quiet
          - cache store
    dependencies: []
  - name: 'Dockerize '
    dependencies:
      - Build Aurelia SPA
      - Build Quarkus API
    task:
      jobs:
        - name: docker build primes/api-quarkus
          commands:
            - cd quarkus-api/
            - 'docker build -f ./src/main/docker/Dockerfile.jvm -t "primes/api-quarkus:$SEMAPHORE_GIT_SHA" .'
        - name: docker build primes/web-app
          commands:
            - artifact pull workflow aurelia-spa --destination lighttpd/htdocs
            - 'docker build -t "primes/web-app:$SEMAPHORE_GIT_SHA" lighttpd/'
      prologue:
        commands:
          - checkout
  - name: Generate Changelog
    dependencies: []
    task:
      jobs:
        - name: git-changelog
          commands:
            - echo "Changelog" > CHANGELOG.MD
            - artifact push workflow CHANGELOG.MD
  - name: Generate Release
    dependencies:
      - 'Dockerize '
      - Generate Changelog
    task:
      jobs:
        - name: Push Release to GitHub
          commands:
            - artifact pull workflow CHANGELOG.MD
  - name: Build Quarkus API
    dependencies: []
    task:
      agent:
        machine:
          type: e1-standard-2
          os_image: ubuntu1804
        containers:
          - name: main
            image: 'ghcr.io/graalvm/graalvm-ce:latest'
      jobs:
        - name: mvn package
          commands:
            - ./mvnw $MAVEN_CLI_OPTS clean package $MAVEN_OPTS
      env_vars:
        - name: MAVEN_CLI_OPTS
          value: '--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true'
        - name: MAVEN_OPTS
          value: '-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true'
      prologue:
        commands:
          - checkout
          - cd quarkus-api/
          - chmod +x ./mvnw
promotions:
  - name: Production
    pipeline_file: pipeline_2.yml
  - name: Deploy
    pipeline_file: pipeline_3.yml
