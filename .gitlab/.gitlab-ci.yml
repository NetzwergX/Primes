image: mcr.microsoft.com/dotnet/core/sdk:latest

variables:
  NUGET_PACKAGES_DIRECTORY: '.nuget'
  NPM_PACKAGES_DIRECTORY: 'Prime.UI/node_modules/'

stages:
  - build
  - test

dotnet_build:
  stage: build
  only:
    - branches
  before_script:
    - 'dotnet restore --packages $NUGET_PACKAGES_DIRECTORY'
  script:
    - 'dotnet build --configuration Release --no-restore'  # build the project
  artifacts:
    name: prime-webapi-release
    paths:
      - './Prime.WebApi/bin/Release/netcoreapp3.1/'

dotnet_test:
  stage: test
  only:
    - branches
  script:
    - 'dotnet test --no-build --no-restore --collect:"XPlat Code Coverage" --results-directory ./TestResults'  # running NUnit tests
  artifacts:
    when: always # even when it fails
    paths:
      - '.\TestResults'  # saving NUnit results to copy to deploy folder
  dependencies:
    - dotnet_build

webpack_build:
    image: node:latest
    stage: build
    only: 
      - branches
    before_script:
        - 'cd ""./Prime.UI/""'
    script:
      - 'npm install --silent'
      - 'npm run build'
    after_script:
      - 'cd ..'
    artifacts:
        name: prime-ui-release
        paths:
          - './Prime.UI/dist'
